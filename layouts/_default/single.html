{{ define "main" }}
<div class="product-detail-page">
  <div class="product-detail-header">
    <button onclick="history.back()" class="btn-secondary">â† Quay vá»</button>
    <h1 class="product-title">{{ .Title }}</h1>
  </div>

  <div class="product-detail-body">
    <div class="product-image">
      <img src="{{ .Params.image }}" alt="{{ .Title }}">
    </div>

    <div class="product-info">
      <p class="product-description">{{ .Params.description }}</p>

      <!-- ğŸ‘‡ Gá»i specs theo loáº¡i sáº£n pháº©m -->
      {{ if eq .Params.type "cpu" }}
        {{ partial "specs-cpu.html" . }}
      {{ else if eq .Params.type "mainboard" }}
        {{ partial "specs-mainboard.html" . }}
      {{ else if eq .Params.type "ram" }}
        {{ partial "specs-ram.html" . }}
      {{ else if eq .Params.type "gpu" }}
        {{ partial "specs-gpu.html" . }}
      {{ else if eq .Params.type "manhinh" }}
        {{ partial "specs-manhinh.html" . }}
      {{ else if eq .Params.type "loavatainghe" }}
        {{ partial "specs-loavatainghe.html" . }}
      {{ else if eq .Params.type "banphim" }}
        {{ partial "specs-banphim.html" . }}
      {{ else if eq .Params.type "conchuot" }}
        {{ partial "specs-conchuot.html" . }}
      {{ else if eq .Params.type "tannhiet" }}
        {{ partial "specs-tannhiet.html" . }}
      {{ else if eq .Params.type "vocase" }}
        {{ partial "specs-vocase.html" . }}
      {{ else if eq .Params.type "ocung" }}
        {{ partial "specs-ocung.html" . }}
      {{ else if eq .Params.type "ocungngoai" }}
        {{ partial "specs-ocungngoai.html" . }}
      {{ else if eq .Params.type "micro" }}
        {{ partial "specs-micro.html" . }}
      {{ else }}
        <p>ThÃ´ng sá»‘ ká»¹ thuáº­t chÆ°a Ä‘Æ°á»£c cáº­p nháº­t cho loáº¡i sáº£n pháº©m nÃ y.</p>
      {{ end }}

      <!-- ğŸ’° GiÃ¡ vÃ  nÃºt mua -->
      <div class="product-price-highlight">
        {{ if .Params.price }}
          {{ replace (printf "%d" .Params.price) "," "." }} Ä‘
        {{ else }}
          Vui lÃ²ng liÃªn há»‡
        {{ end }}
      </div>

      <button
        class="snipcart-add-item btn-primary"
        data-item-id="{{ .Params.snipcart_id }}"
        data-item-name="{{ .Title }}"
        data-item-price="{{ .Params.price }}"
        data-item-url="{{ .Permalink }}"
        data-item-image="{{ .Params.image }}">
        ğŸ›’ ThÃªm vÃ o Giá» HÃ ng
      </button>

      <!-- â­ Form Ä‘Ã¡nh giÃ¡ sáº£n pháº©m -->
      <div class="review-form">
        <h3>Gá»­i Ä‘Ã¡nh giÃ¡ cá»§a báº¡n</h3>
        <select id="rating">
          <option value="5">â˜…â˜…â˜…â˜…â˜…</option>
          <option value="4">â˜…â˜…â˜…â˜…</option>
          <option value="3">â˜…â˜…â˜…</option>
          <option value="2">â˜…â˜…</option>
          <option value="1">â˜…</option>
        </select>
        <textarea id="comment" placeholder="Viáº¿t bÃ¬nh luáº­n..."></textarea>
        <input type="text" id="username" placeholder="TÃªn cá»§a báº¡n">
        <input type="email" id="email" placeholder="Email cá»§a báº¡n">
        <button onclick="submitReview()">Gá»­i Ä‘Ã¡nh giÃ¡</button>
      </div>
    </div>
  </div>
</div>

<!-- ğŸ”¥ Firebase + xá»­ lÃ½ Ä‘Ã¡nh giÃ¡ -->
<script type="module">
  import { db } from "/js/firebase-init.js";
  import {
    collection,
    addDoc,
    query,
    where,
    getDocs,
    orderBy
  } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  async function submitReview() {
    const rating = parseInt(document.getElementById("rating").value);
    const comment = document.getElementById("comment").value;
    const username = document.getElementById("username").value;
    const email = document.getElementById("email").value;
    const productId = "{{ .Params.snipcart_id }}";

    if (!comment || !username || !email) {
      alert("Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin.");
      return;
    }

    try {
      await addDoc(collection(db, "reviews"), {
        productId,
        rating,
        comment,
        username,
        email,
        timestamp: new Date()
      });
      alert("ÄÃ¡nh giÃ¡ Ä‘Ã£ Ä‘Æ°á»£c gá»­i!");
      document.getElementById("comment").value = "";
    } catch (e) {
      console.error("Lá»—i khi gá»­i Ä‘Ã¡nh giÃ¡:", e);
    }
  }

  async function loadReviews() {
    const productId = "{{ .Params.snipcart_id }}";
    const q = query(
      collection(db, "reviews"),
      where("productId", "==", productId),
      orderBy("timestamp", "desc")
    );
    const querySnapshot = await getDocs(q);
    const container = document.createElement("div");
    container.className = "review-list";
    document.querySelector(".review-form").after(container);

    querySnapshot.forEach((doc) => {
      const data = doc.data();
      const item = document.createElement("div");
      item.innerHTML = `
        <strong>${data.username}</strong> - ${"â˜…".repeat(data.rating)}
        <p>${data.comment}</p>
      `;
      container.appendChild(item);
    });
  }

  loadReviews();
</script>
{{ end }}